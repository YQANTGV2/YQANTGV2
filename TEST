if _G.AutoFollowInitialized then return end
_G.AutoFollowInitialized = true

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

local animationIds = {
	"rbxassetid://10503381238",
	"rbxassetid://10468665991",
	"rbxassetid://12272894215",
	"rbxassetid://13379003796"
}

local lastTriggerTime = 0
local currentHumanoid
local connection

local function processAction()
	local char = LocalPlayer.Character
	local myRoot = char and char:FindFirstChild("HumanoidRootPart")
	if not myRoot then return end

	myRoot.CFrame = myRoot.CFrame + myRoot.CFrame.LookVector * -3

	local comm = char:FindFirstChild("Communicate")
	if comm then
		local args = {
			{ Dash = Enum.KeyCode.W, Key = Enum.KeyCode.Q, Goal = "KeyPress" }
		}
		comm:FireServer(unpack(args))
	end
end

local function onAnimationPlayed(hum, anim)
	if not _G.AutoFollowEnabled then return end

	local id = anim.Animation.AnimationId
	local now = tick()

	if id == "rbxassetid://12296113986" then
		if now - lastTriggerTime < 5 then return end
		lastTriggerTime = now

		task.delay(1.7, function()
			if _G.AutoFollowEnabled then
				processAction()
			end
		end)
	elseif table.find(animationIds, id) then
		task.delay(0.31, function()
			if _G.AutoFollowEnabled then
				processAction()
			end
		end)
	end
end

local function connectHumanoid(char)
	local hum = char:WaitForChild("Humanoid")
	if connection then connection:Disconnect() end
	currentHumanoid = hum
	connection = hum.AnimationPlayed:Connect(function(anim)
		onAnimationPlayed(hum, anim)
	end)
end

-- Kết nối nhân vật hiện tại và sau này
if LocalPlayer.Character then
	connectHumanoid(LocalPlayer.Character)
end
LocalPlayer.CharacterAdded:Connect(connectHumanoid)

-- Theo dõi trạng thái toggle (optional print)
RunService.Heartbeat:Connect(function()
	if _G.AutoFollowEnabled == nil then
		_G.AutoFollowEnabled = false
	end
end)
